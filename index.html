<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Crafting Calculator</title>
  <style>
    body { font-family: sans-serif; max-width: 900px; margin: auto; padding: 20px; }
    .item-row { margin-bottom: 10px; position: relative; }
    .results, .source-info { margin-top: 20px; }
    table { border-collapse: collapse; width: 100%; margin-top: 10px; }
    th, td { border: 1px solid #ccc; padding: 8px; }
    input[type="text"] { width: 300px; padding: 5px; margin-right: 10px; }
    button { padding: 6px 12px; cursor: pointer; margin-right: 5px; }
    .selected-items { margin-top: 10px; }
    .selected-items li { margin-bottom: 4px; }
    .material-search { margin-top: 30px; }
  </style>
</head>
<body>
  <h1>Fantasy Life I Crafting Calculator</h1>

  <div id="crafting-form">
    <div class="item-row">
      <input type="text" id="search-box" list="suggestions" placeholder="Type item name...">
      <datalist id="suggestions"></datalist>
      <input type="number" id="item-qty" value="1" min="1">
      <button onclick="addItem()">Add</button>
      <button onclick="clearItems()">Clear</button>
    </div>
    <ul class="selected-items" id="selected-items-list"></ul>
  </div>

  <div class="results">
    <h2>Required Base Materials</h2>
    <ul id="materials-list"></ul>
  </div>

  <div class="source-info">
    <h2>Material Sources</h2>
    <div id="sources-table"></div>
  </div>

  <div class="material-search">
    <h2>Search Material Source</h2>
    <input type="text" id="material-search-box" placeholder="Search material name..." oninput="searchMaterialSource()">
    <div id="material-search-result"></div>
  </div>

  <script>
    let recipes = {}, recipesLower = {}, materials = {}, materialsLower = {};
    let selectedItems = [], allItemNames = [];

    async function loadData() {
      const recipesResp = await fetch('recipes.json');
      const materialsResp = await fetch('materials.json');
      recipes = await recipesResp.json();
      materials = await materialsResp.json();

      for (const name in recipes) recipesLower[name.toLowerCase()] = name;
      for (const name in materials) materialsLower[name.toLowerCase()] = materials[name];

      allItemNames = Object.keys(recipes).sort();
      const suggestionList = document.getElementById('suggestions');
      allItemNames.forEach(name => {
        const option = document.createElement('option');
        option.value = name;
        suggestionList.appendChild(option);
      });
    }

    function addItem() {
      const rawInput = document.getElementById('search-box').value.trim();
      const lookupName = rawInput.toLowerCase();
      const matchedName = recipesLower[lookupName];
      const qty = parseInt(document.getElementById('item-qty').value);
      if (!matchedName) {
        alert(`No recipe found for "${rawInput}".`);
        return;
      }
      selectedItems.push({ name: matchedName, quantity: qty });
      updateSelectedItems();
      calculateMaterials();
    }

    function updateSelectedItems() {
      const list = document.getElementById('selected-items-list');
      list.innerHTML = '';
      selectedItems.forEach((item, index) => {
        const li = document.createElement('li');
        li.textContent = `${item.name} × ${item.quantity} `;
        const btn = document.createElement('button');
        btn.textContent = '✕';
        btn.onclick = () => {
          selectedItems.splice(index, 1);
          updateSelectedItems();
          calculateMaterials();
        };
        li.appendChild(btn);
        list.appendChild(li);
      });
    }

    function clearItems() {
      selectedItems = [];
      document.getElementById('search-box').value = '';
      document.getElementById('item-qty').value = 1;
      document.getElementById('materials-list').innerHTML = '';
      document.getElementById('sources-table').innerHTML = '';
      document.getElementById('selected-items-list').innerHTML = '';
    }

    function calculateMaterials() {
      const totals = {};
      let totalItems = 0;
      function addMaterials(itemName, qtyNeeded) {
        if (!recipes[itemName]) return;
        const { quantity: outputQty, materials: mats } = recipes[itemName];
        if (!mats) return;
        const multiplier = qtyNeeded / outputQty;
        for (const [mat, qty] of Object.entries(mats)) {
          if (recipes[mat]) {
            addMaterials(mat, qty * multiplier);
          } else {
            totals[mat] = (totals[mat] || 0) + qty * multiplier;
          }
        }
      }
      selectedItems.forEach(({ name, quantity }) => {
        addMaterials(name, quantity);
        totalItems += quantity;
      });
      const list = document.getElementById('materials-list');
      list.innerHTML = '';
      const summary = document.createElement('li');
      summary.innerHTML = `<strong>Total crafted items selected: ${totalItems}</strong>`;
      list.appendChild(summary);
      Object.entries(totals).sort().forEach(([mat, qty]) => {
        const li = document.createElement('li');
        li.textContent = `${mat} × ${Math.ceil(qty)}`;
        list.appendChild(li);
      });
      showSources(totals);
    }

    function showSources(totals) {
      const container = document.getElementById('sources-table');
      const table = document.createElement('table');
      table.innerHTML = '<tr><th>Material</th><th>Qty</th><th>Method</th><th>Locations</th></tr>';
      Object.entries(totals).sort().forEach(([mat, qty]) => {
        const sources = materials[mat] || materialsLower[mat.toLowerCase()] || [{ method: 'Unknown', locations: [] }];
        sources.forEach((src, idx) => {
          const row = document.createElement('tr');
          row.innerHTML = `
            <td>${idx === 0 ? mat : ''}</td>
            <td>${idx === 0 ? Math.ceil(qty) : ''}</td>
            <td>${src.method}</td>
            <td>${src.locations.join(', ')}</td>
          `;
          table.appendChild(row);
        });
      });
      container.innerHTML = '';
      container.appendChild(table);
    }

    function searchMaterialSource() {
      const raw = document.getElementById('material-search-box').value.trim().toLowerCase();
      const sources = materials[raw] || materialsLower[raw] || null;
      const container = document.getElementById('material-search-result');
      container.innerHTML = '';
      if (!sources) {
        container.textContent = 'No source information found.';
        return;
      }
      const table = document.createElement('table');
      table.innerHTML = '<tr><th>Method</th><th>Locations</th></tr>';
      sources.forEach(src => {
        const row = document.createElement('tr');
        row.innerHTML = `<td>${src.method}</td><td>${src.locations.join(', ')}</td>`;
        table.appendChild(row);
      });
      container.appendChild(table);
    }

    loadData();
  </script>
</body>
</html>
